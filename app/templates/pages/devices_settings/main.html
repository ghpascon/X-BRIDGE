{% extends "base.html" %} {% block content %}
<div class="max-w-6xl mx-auto px-4 py-10">
  <header class="mb-6">
    <h1 class="text-2xl font-semibold text-gray-900">Devices</h1>
    <p class="text-sm text-gray-600">Current devices and their status</p>
  </header>

  <div x-data="devicesList()" x-init="init()">
    <div x-show="loading" class="py-3 text-center text-gray-500">
      Loading devicesâ€¦
    </div>

    <div x-show="!loading" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
      <template x-for="device in devices" :key="device.name">
        <div
          class="flex items-center justify-between bg-white rounded-md shadow-sm p-2 text-sm"
        >
          <div class="flex items-center gap-3 truncate">
            <div
              class="w-3 h-3 rounded-full flex-shrink-0 mt-0.5"
              :class="!device.is_connected ? 'bg-red-500' : (device.is_connected && device.is_reading) ? 'bg-green-500' : 'bg-yellow-500'"
              :title="!device.is_connected ? 'Disconnected' : (device.is_reading ? 'Reading' : 'Connected')"
            ></div>
            <div class="truncate">
              <div
                class="font-medium text-gray-800 truncate"
                x-text="device.name"
              ></div>
              <div
                class="text-xs text-gray-400 truncate"
                x-text="device.device_type || 'unknown'"
              ></div>
            </div>
          </div>

          <div class="flex flex-col items-end ml-2 text-xs text-gray-600">
            <span
              :class="device.is_connected ? 'text-green-600' : 'text-red-600'"
              x-text="device.is_connected ? 'Connected' : 'Disconnected'"
            ></span>
            <span
              :class="device.is_reading ? 'text-blue-600' : 'text-gray-400'"
              x-text="device.is_reading ? 'Reading' : 'Idle'"
            ></span>
          </div>
        </div>
      </template>
    </div>

    <div
      x-show="!loading && devices.length === 0"
      class="py-6 text-center text-gray-400"
    >
      No devices found.
    </div>
  </div>
</div>

<script>
  function devicesList() {
    return {
      devices: [],
      loading: false,
      _fetching: false,

      async init() {
        await this.loadDevices(true);
        setInterval(() => {
          if (!this._fetching) this.loadDevices(false);
        }, 3000);
      },

      async loadDevices(force = false) {
        if (this._fetching) return;
        this._fetching = true;
        if (force || this.devices.length === 0) this.loading = true;
        try {
          const res = await fetch('{{ url_for("get_devices_info") }}');
          if (res.ok) {
            const data = await res.json();
            const newList = Array.isArray(data) ? data : [];

            // update in-place to avoid heavy DOM re-renders
            const existingByName = Object.fromEntries(
              this.devices.map(function (d) {
                return [d.name, d];
              }),
            );
            const newNames = new Set(
              newList.map(function (d) {
                return d.name;
              }),
            );

            newList.forEach(function (nd) {
              const ex = existingByName[nd.name];
              if (ex) Object.assign(ex, nd);
              else this.devices.push(nd);
            }, this);

            for (let i = this.devices.length - 1; i >= 0; i--) {
              if (!newNames.has(this.devices[i].name))
                this.devices.splice(i, 1);
            }
          } else {
            if (force) this.devices.splice(0, this.devices.length);
          }
        } catch (err) {
          console.error("Error loading devices:", err);
          if (force) this.devices.splice(0, this.devices.length);
        } finally {
          if (force || this.devices.length === 0) this.loading = false;
          this._fetching = false;
        }
      },
    };
  }
</script>

{% endblock %}
